<?xml version='1.0' encoding='utf-8' ?>
<html xmlns="http://www.w3.org/1999/xhtml">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
		<title>PrivacyLens-2.5.0</title>
		<link type="text/css" rel="stylesheet" href="style.css"/>
	</head>
	<body>
		<p>This document contains the PrivacyLens deployment guide and the general manual.</p>
		<p>PrivacyLens is an extension for the Shibboleth Identity Provider 2.x. It allows to make users authenticating at an Identity Provider to accept terms of use and to give attribute release consent. 
			<a href="https://github.com/cmu-cylab-privacylens/PrivacyLens">More information about the concept of PrivacyLens</a>.
		</p>
		<p>Notes about this guide:</p>
		<ul>
			<li>This guide assumes that PrivacyLens will be installed on a Linux system. It&#8217;s also possible to install it on a different operating system, like Windows. In this case, you may need to adapt some paths and commands accordingly.</li>
			<li>The guide shows paths and commands using variables like, e.g, 
				<code>$IDP_INSTALL$</code>, 
				<code>$_IDP_HOME$</code> or 
				<code>$PLENS_INSTALL$</code>. You need to substitute these variables by the real paths, except where it is explicitly stated that you don&#8217;t need to substitute them.
			</li>
		</ul>
		<h1 id="Assumptions">Assumptions</h1>
		<ul>
			<li>The 
				<a href="http://shibboleth.net/">Shibboleth Identity Provider</a> is unpacked at 
				<code>$IDP_INSTALL$</code> (e.g., 
				<code>/usr/local/src/shibboleth-identity-provider-#version#</code>).
			</li>
			<li>The Shibboleth Identity Provider is installed at 
				<code>$IDP_HOME$</code> (e.g., 
				<code>/opt/shibboleth-idp</code>).
			</li>
			<li>
				<a href="https://github.com/cmu-cylab-privacylens/PrivacyLens">PrivacyLens</a> is built and its zipfile unpacked at 
				<code>$PLENS_INSTALL$</code> (e.g., 
				<code>/usr/local/src/PrivacyLens-#version#</code>).
			</li>
		</ul>
		<h1 id="a1Installation">1 Installation</h1>
		<h2 id="a1.1Prerequisites">1.1 Prerequisites</h2>
		<ul>
			<li>Shibboleth Identity Provider 2.3 or greater.</li>
			<li>Database which supports 
				<acronym title="Java Database Connectivity">JDBC</acronym>.
			</li>
		</ul>
		<h2 id="a1.2LibraryInstallation">1.2 Library Installation</h2>
		<p>If building from source, unpack the sources and build them with Maven
			<br/>(mvn install) to obtain the PrivacyLens zipfile.
		</p>
		<p>Copying the libraries to the IdPs library directory:</p>
		<ul>
			<li>
				<code>cp $PLENS_INSTALL$/lib/*.jar $IDP_INSTALL$/lib</code>
			</li>
			<li>
				<code>cp $PLENS_INSTALL$/lib/jdbc/*.jar $IDP_INSTALL$/lib</code>
			</li>
			<li>Provide the JDBC connector for your database to the classpath of the IdP. You might use one of the provided MySQL or HSQL JDBC connector: <br /> 
				<code>cp $PLENS_INSTALL$/lib/jdbc/optional/#jdbc-connector#.jar $IDP_INSTALL$/lib</code>
			</li>
		</ul>
		<blockquote class="note">
			<p>Assure that only one version of each library is present in 
				<code>$IDP_INSTALL$/lib</code>.
			</p>
		</blockquote>
		<h2 id="a1.3ConfigurationTemplate">1.3 Configuration Template</h2>
		<p>Copying the configuration template to the IdPs configuration directory:</p>
		<ul>
			<li>
				<code>cp</code> 
				<a href="configuration/uApprove.properties" class="file">$PLENS_INSTALL$/manual/configuration/uApprove.properties</a> 
				<code>$IDP_HOME$/conf</code>
			</li>
			<li>
				<code>cp</code> 
				<a href="configuration/uApprove.xml" class="file">$PLENS_INSTALL$/manual/configuration/uApprove.xml</a> 
				<code>$IDP_HOME$/conf</code>
			</li>
		</ul>
		<h2 id="a1.4Webappfiles">1.4 Webapp files</h2>
		<p>Copying of the web application files like the 
			<acronym title="Java Server Pages">JSP</acronym>s, 
			<acronym title="Cascading Style Sheet">CSS</acronym> files and images to the IdPs webapp directory:
		</p>
		<ul>
			<li>
				<code>mkdir $IDP_INSTALL$/src/main/webapp/uApprove</code>
			</li>
			<li>
				<code>cp $PLENS_INSTALL$/webapp/* $IDP_INSTALL$/src/main/webapp/uApprove</code>
			</li>
		</ul>
		<h2 id="a1.5DatabasePreparation">1.5 Database Preparation</h2>
		<blockquote class="note">
			<p>The following database parameters are examples. Adapt the values as required. Especially, choose a secure password.</p>
		</blockquote>
		<ul>
			<li>Create a database with the name &#8222;uApprove&#8221;.</li>
			<li>Create a database user with the username &#8222;uApprove&#8221; and password &#8222;secret&#8221;.</li>
			<li>Grant 
				<code>INSERT, SELECT, UPDATE, DELETE</code> rights for the user.
			</li>
			<li>Create the initial table structures using the schemas:
				<ul>
					<li>
						<a href="storage/terms-of-use-schema.sql" class="file">$PLENS_INSTALL$/manual/storage/terms-of-use-schema.sql</a>.
					</li>
					<li>
						<a href="storage/attribute-release-schema.sql" class="file">$PLENS_INSTALL$/manual/storage/attribute-release-schema.sql</a>.
					</li>
				</ul>
			</li>
		</ul>
		<h1 id="a2BasicDeployment">2 Basic Deployment</h1>
		<h2 id="a2.1WebApplicationDeploymentDescriptor">2.1 Web Application Deployment Descriptor</h2>
		<p>Extend the IdP web application deployment descriptor (
			<code>$IDP_INSTALL$/src/main/webapp/WEB-INF/web.xml</code>). Adapt your existing file as shown below.
		</p>
		<ul>
			<li>Add 
				<code>$IDP_HOME$/conf/uApprove.xml</code> to the 
				<code>contextConfigLocation</code> context parameter. Keep the 
				<code>$IDP_HOME$</code> variables. They will be replaced during the re-deployment of the IdP in a later step.
			</li>
			<li>Add the required filters and servlets as shown.</li>
		</ul>
		<pre><pre>
&lt;web-app ...>

    &lt;context-param>
        &lt;param-name>contextConfigLocation&lt;/param-name>
        &lt;param-value>$IDP_HOME$/conf/internal.xml; $IDP_HOME$/conf/service.xml; $IDP_HOME$/conf/uApprove.xml&lt;/param-value>
    &lt;/context-param>

    &lt;!-- IdP Listeners, Filters and Servlets -->
    &lt;!-- ...                                 -->
    
    
    &lt;!-- uApprove Filter and Servlets -->
    
    &lt;filter>
        &lt;filter-name>uApprove&lt;/filter-name>
        &lt;filter-class>ch.SWITCH.aai.uApprove.Intercepter&lt;/filter-class>
    &lt;/filter>

    &lt;filter-mapping>
        &lt;filter-name>uApprove&lt;/filter-name>
        &lt;url-pattern>/profile/Shibboleth/SSO&lt;/url-pattern>
        &lt;url-pattern>/profile/SAML1/SOAP/AttributeQuery&lt;/url-pattern>
        &lt;url-pattern>/profile/SAML1/SOAP/ArtifactResolution&lt;/url-pattern>
        &lt;url-pattern>/profile/SAML2/POST/SSO&lt;/url-pattern>
        &lt;url-pattern>/profile/SAML2/POST-SimpleSign/SSO&lt;/url-pattern>
        &lt;url-pattern>/profile/SAML2/Redirect/SSO&lt;/url-pattern>
        &lt;url-pattern>/profile/SAML2/Unsolicited/SSO&lt;/url-pattern>
        &lt;url-pattern>/Authn/UserPassword&lt;/url-pattern>
    &lt;/filter-mapping>

    &lt;servlet>
        &lt;servlet-name>uApprove - Terms Of Use&lt;/servlet-name>
        &lt;servlet-class>ch.SWITCH.aai.uApprove.tou.ToUServlet&lt;/servlet-class>
    &lt;/servlet>

    &lt;servlet-mapping>
        &lt;servlet-name>uApprove - Terms Of Use&lt;/servlet-name>
        &lt;url-pattern>/uApprove/TermsOfUse&lt;/url-pattern>
    &lt;/servlet-mapping>

    &lt;servlet>
        &lt;servlet-name>uApprove - Attribute Release&lt;/servlet-name>
        &lt;servlet-class>ch.SWITCH.aai.uApprove.ar.AttributeReleaseServlet&lt;/servlet-class>
    &lt;/servlet>

    &lt;servlet-mapping>
        &lt;servlet-name>uApprove - Attribute Release&lt;/servlet-name>
        &lt;url-pattern>/uApprove/AttributeRelease&lt;/url-pattern>
    &lt;/servlet-mapping>

&lt;servlet>
&lt;servlet-name>PrivacyLens - AR Admin&lt;/servlet-name>
&lt;servlet-class>ch.SWITCH.aai.uApprove.ar.AdminServlet&lt;/servlet-class>
&lt;/servlet>

&lt;servlet-mapping>
&lt;servlet-name>PrivacyLens - AR Admin&lt;/servlet-name>
&lt;url-pattern>/uApprove/AdminServlet&lt;/url-pattern>
&lt;/servlet-mapping>

&lt;servlet>
&lt;servlet-name>PrivacyLens - AR AJAX&lt;/servlet-name>
&lt;servlet-class>ch.SWITCH.aai.uApprove.ar.AttributeReleaseAjaxServlet&lt;/servlet-class>
&lt;/servlet>

&lt;servlet-mapping>
&lt;servlet-name>PrivacyLens - AR AJAX&lt;/servlet-name>
&lt;url-pattern>/uApprove/AttributeReleaseAjaxServlet&lt;/url-pattern>
&lt;/servlet-mapping>

&lt;servlet>
&lt;servlet-name>PrivacyLens - Debug&lt;/servlet-name>
&lt;servlet-class>ch.SWITCH.aai.uApprove.DebugViewServlet&lt;/servlet-class>
&lt;/servlet>

&lt;servlet-mapping>
&lt;servlet-name>PrivacyLens - Debug&lt;/servlet-name>
&lt;url-pattern>/uApprove/DebugView&lt;/url-pattern>
&lt;/servlet-mapping>

&lt;/web-app>
</pre></pre>
		<h2 id="a2.2CustomConfiguration">2.2 Custom Configuration</h2>
		<p>In 
			<code>$IDP_HOME$/conf/uApprove.xml</code> change:
		</p>
		<pre><pre>&lt;context:property-placeholder location="classpath:/configuration/uApprove.properties" />
</pre></pre>
		<p>to:</p>
		<pre><pre>&lt;context:property-placeholder location="file:$IDP_HOME$/conf/uApprove.properties" />
</pre></pre>
		<p>Replace the variable $IDP_HOME$ by the correct path, e.g. 
			<code>/opt/shibboleth-idp</code> (so that the whole value looks like 
			<code>file:/opt/shibboleth-idp/conf/uApprove.properties</code> for example).
		</p>
		<p>Customize 
			<code>$IDP_HOME$/conf/uApprove.properties</code> according your database environment and required features. See inline documentation of 
			<a href="configuration/uApprove.properties">uApprove.properties</a> for configuration options.
		</p>
		<p>In case you enable the &#8218;Terms of Use&#8217; module (enabled by default), you need to provide an appropriate text
			<br/>suitable for your organization.
		</p>
		<p>An example &#8218;Terms Of Use&#8217; HTML file can be found in 
			<code>$PLENS_INSTALL$/manual/examples/terms-of-use.html</code>.
		</p>
		<ul>
			<li>Copy 
				<code>$PLENS_INSTALL$/manual/examples/terms-of-use.html</code> to 
				<code>$IDP_HOME$/conf/terms-of-use.html</code>.
			</li>
		</ul>
		<pre><pre>cp $PLENS_INSTALL$/manual/examples/terms-of-use.html $IDP_HOME$/conf/terms-of-use.html
</pre></pre>
		<ul>
			<li>Adapt 
				<code>$IDP_HOME$/conf/terms-of-use.html</code> as required.
			</li>
			<li>Adapt the value of 
				<code>tou.resource</code> in 
				<code>$IDP_HOME$/conf/uApprove.properties</code> accordingly.
			</li>
		</ul>
		<pre><pre>tou.resource = file:$IDP_HOME$/conf/terms-of-use.html
</pre></pre>
		<h2 id="a2.3CustomTemplates">2.3 Custom Templates</h2>
		<p>In case you want to customize the templates, follow section 
			<a href="#CustomViewTemplates">Custom View Templates</a>.
		</p>
		<p>At least, you should copy your organization&#8217;s logo to the file 
			<code>$IDP_INSTALL$/src/main/webapp/uApprove/logo.png</code>, since a placeholder logo is installed by default.
			<br/>You may also want to put your federation&#8217;s logo to the file 
			<code>$IDP_INSTALL$/src/main/webapp/uApprove/federation-logo.png</code> (which is an empty placeholder logo by default).
			<br/>
			<em>(For the SWITCHaai federation, the logo is available at 
				<a href="http://www.switch.ch/aai/design/images/switchaai-logo.png">http://www.switch.ch/aai/design/images/switchaai-logo.png</a>.)
			</em>
		</p>
		<h2 id="a2.4Deployment">2.4 Deployment</h2>
		<p>To activate PrivacyLens the IdP must be re-deployed:</p>
		<pre><pre>cd $IDP_INSTALL$
./install.sh
</pre></pre>
		<p>You also need to restart your Java web application server (e.g. Tomcat or Jetty).</p>
		<h1 id="a3Upgrade">3 Upgrade </h1>
		<p>There are different update procedures depending on the version that is updated.</p>
		<h2 id="a3.1UpgradefromuApprove2.3">3.1 Upgrade from uApprove &lt; 2.3</h2>
		<blockquote class="warning">
			<p>If your upgrading from uApprove &lt; 2.3 you have to completly remove this old version first and perform a clean install.
				<br/>Please have a look at the 
				<a href="#a1Installation">installation instructions</a> above for further information on how to install PrivacyLens.
			</p>
		</blockquote>
		<ul>
			<li>Legacy uApprove (&lt; 2.3) deployment: Please remove it.</li>
			<li>Configuration files: Please use the new configuration file and tailor them to your needs. Note: The new ToU is an HTML file, which you can customize, just copy the content from your lecacy ToU XML to a plain HTML file.</li>
			<li>
				<acronym title="JavaServer Pages">JSP</acronym>: Please use the new provided JSP files. If you use 
				<a href="#a4.1ResetAttributeReleaseConsent">Reset Attribute Release Consent</a>, please adjust your 
				<code>login.jsp</code>.
			</li>
			<li>Database Migration: It is possible to migrate ToU acceptance and attribute release consent data using the 
				<a href="#DatabaseMigration">provided data migration script</a>.
			</li>
		</ul>
		<blockquote class="note">
			<p>If 
				<em>Terms Of Use Content Comparison</em> and/or 
				<em>Attribute Value Comparison</em> feature will be used,
				<br/>the lecacy database entries can not be used and must not be migrated.
			</p>
		</blockquote>
		<h3 id="DatabaseMigration">Database Migration</h3>
		<p>Migrate lecacy database to the new database:</p>
		<pre><pre>java -cp "$PLENS_INSTALL$/scripts/lib/*.jar:$PLENS_INSTALL$/lib/jdbc/optional/*.jar" groovy.ui.GroovyMain \
  $PLENS_INSTALL$/scripts/StorageMigration.groovy /opt/uApprove/conf/database.properties $IDP_HOME$/conf/uApprove.properties
</pre></pre>
		<h2 id="a3.2UpgradefromuApprove2.3to2.4">3.2 Upgrade from uApprove 2.3 to 2.4</h2>
		<ul>
			<li>In version 2.4 
				<a href="http://www.mchange.com/projects/c3p0/">
					<code>c3p0</code>
				</a> is used as the connection pooling library (instead of 
				<code>boneCP</code> in uApprove 2.3). The reason was, that some deployers reported connection repairing issues with remote databases. 
				<code>c3p0</code> offers also an easier deployment, because this library is used by the IdP as well. Please assure following upgrade steps:
				<ul>
					<li>Adjust the 
						<code>uApprove.dataSource</code> bean in 
						<code>$IDP_HOME$/conf/uApprove.xml</code> (i.e., replace the 
						<code>bonecp.BoneCPDataSource</code> with the 
						<code>c3p0.ComboPooledDataSource</code>, see 
						<a href="configuration/uApprove.xml" class="file">$PLENS_INSTALL$/manual/configuration/uApprove.xml</a>). Please refer to 
						<a href="#JDBCConnectionPoolTuning">JDBC Connection Pool Tuning</a> for advanced configuration properties.
					</li>
				</ul>
			</li>
		</ul>
		<h2 id="a3.3UpgradefromuApprove2.4to2.5">3.3 Upgrade from uApprove 2.4 to 2.5</h2>
		<p>uApprove version 2.5 mainly introduces support for interfederation, besides some fixes and other minor features.
			<br/>You should upgrade to uApprove 2.5 in case you participate in interfederation. If you don&#8217;t participate in
			<br/>interfederation, you are not required to do the upgrade, but the upgrade is still recommended.
		</p>
		<p>In version 2.5, the web templates (JSP files, CSS files, images) have been adapted to support the legal requirements of interfederation
			<br/>(see 
			<a href="http://www.switch.ch/aai/support/documents/legaltemplates.html">Legal Templates for SWITCHaai</a>).
			<br/>This means that you also need to update the web application files in 
			<code>$IDP_INSTALL$/src/main/webapp/uApprove</code>.
			<br/>Because the text translations are contained in the library file, keeping the old web application files would
			<br/>mean that some texts are not shown anymore. In case you have customized the old web application files
			<br/>of uApprove, you should install the new web application files and re-apply your customizations.
		</p>
		<p>The upgrade procedure is:</p>
		<ul>
			<li>
				<code>rm $IDP_INSTALL$/lib/uApprove-#old-version#.jar</code>
			</li>
			<li>
				<code>cp $PLENS_INSTALL$/lib/uApprove-#new-version#.jar $IDP_INSTALL$/lib</code>
			</li>
		</ul>
		<p>Optionally update the JDBC dependencies:</p>
		<ul>
			<li>
				<code>cp $PLENS_INSTALL$/lib/jdbc/*.jar $IDP_INSTALL$/lib</code>
			</li>
		</ul>
		<p>Optionally update the JDBC connector for your database. You might use one of the provided MySQL or HSQL JDBC connector:</p>
		<ul>
			<li>
				<code>cp $PLENS_INSTALL$/lib/jdbc/optional/#jdbc-connector#.jar $IDP_INSTALL$/lib</code><br /><br />Verify that only one version of each library is present in 
				<code>$IDP_INSTALL$/lib</code>.
			</li>
		</ul>
		<p>Update the web application files in 
			<code>$IDP_INSTALL$/src/main/webapp/uApprove</code>. If you have done any customizations
			<br/>of these files, do a backup of the old files first, and then re-apply the customizations after having updated
			<br/>these files
		</p>
		<ul>
			<li>Optionally backup the existing web application files in 
				<code>$IDP_INSTALL$/src/main/webapp/uApprove</code>
			</li>
			<li>
				<code>rm $IDP_INSTALL$/src/main/webapp/uApprove/*</code>
			</li>
			<li>
				<code>cp $PLENS_INSTALL$/webapp/* $IDP_INSTALL$/src/main/webapp/uApprove</code>
			</li>
			<li>Optionally re-apply customizations.
				<ul>
					<li>At least, you should restore your organization&#8217;s logo (file 
						<code>$IDP_INSTALL$/src/main/webapp/uApprove/logo.png</code>), since a placeholder logo is installed by default. You may also want to put your federation&#8217;s logo to the file 
						<code>$IDP_INSTALL$/src/main/webapp/uApprove/federation-logo.png</code> (which is an empty placeholder logo by default). 
						<em>(For the SWITCHaai federation, the logo is available at 
							<a href="http://www.switch.ch/aai/design/images/switchaai-logo.png">http://www.switch.ch/aai/design/images/switchaai-logo.png</a>.)
						</em>
					</li>
				</ul>
			</li>
		</ul>
		<p>In case you want to adapt the text translations, see section 
			<a href="#a4.4Localization">4.4 Localization</a> below.
		</p>
		<p>Adapt some values in 
			<code>$IDP_HOME$/conf/uApprove.properties$</code>:
		</p>
		<ul>
			<li>At 
				<code>database.url</code>, append 
				<code>?autoReconnect=true</code> to the JDBC URL (e.g. 
				<code>database.url = jdbc:mysql://localhost:3306/uApprove?autoReconnect=true</code>).
			</li>
			<li>At 
				<code>ar.attributes.blacklist</code>, add the attribute 
				<code>eduPersonTargetedID</code>.
			</li>
		</ul>
		<p>To finish the upgrade of uApprove the IdP must be re-deployed:</p>
		<pre><pre>cd $IDP_INSTALL$
./install.sh
</pre></pre>
		<p>You also need to restart your Java web application server (e.g. Tomcat or Jetty).</p>
		<h1 id="a4AdvancedDeployment">4 Advanced Deployment</h1>
		<p>This sections contains advanced configuration topics.</p>
		<h2 id="a4.1ResetAttributeReleaseConsent">4.1 Reset Attribute Release Consent</h2>
		<p>For providing the feature that a user is able to clear
			<sup class="footnote">
				<a href="#___fn1">1</a>
			</sup> her attribute release consent during the login flow, 
			<br/>add a checkbox to 
			<code>$IDP_INSTALL$/src/main/webapp/login.jsp</code>:
		</p>
		<pre><pre>&lt;form action="&lt;%=request.getAttribute("actionUrl")%>" method="post">
  ...
  &lt;input id="uApprove.consent-revocation" type="checkbox" name="uApprove.consent-revocation" value="true"/>
  &lt;label for="uApprove.consent-revocation">Clear my attribute release consent&lt;/label>
  ...
&lt;/form>
</pre></pre>
		<h2 id="a4.2Storage">4.2 Storage</h2>
		<h3 id="Fileonly">File-only</h3>
		<p>For a simple deployment a file only database can be used. HSQL provides such an option.
			<br/>Define the according database properties in 
			<code>uApprove.properties</code>:
		</p>
		<pre><pre>database.driver             = org.hsqldb.jdbcDriver
database.url                = jdbc:hsqldb:file:/var/opt/uApprove/hsql.db
database.username           = SA
database.password           = 
</pre></pre>		 
		<p>Initializing the database with the provided schemas:</p>
		<pre><pre>echo "SHUTDOWN;" > /tmp/shutdown
java -jar $HSQLDB_HOME$/lib/sqltool.jar \
  --inlineRC=url=jdbc:hsqldb:file:/var/opt/uApprove/hsql.db,user=SA,password= \
  $PLENS_INSTALL$/manual/storage/terms-of-use-schema.sql /tmp/shutdown
java -jar $HSQLDB_HOME$/lib/sqltool.jar \
  --inlineRC=url=jdbc:hsqldb:file:/var/opt/uApprove/hsql.db,user=SA,password= \
  $PLENS_INSTALL$/manual/storage/attribute-relase-schema.sql /tmp/shutdown
</pre></pre>		    
		<blockquote class="note">
			<p>
				<code>$HSQLDB_HOME$</code> defines the location where the downloaded 
				<a href="http://hsqldb.org/">HSQL distribution</a> is extracted.
			</p>
		</blockquote>
		<blockquote class="note">
			<p>Assure that the user running the container (e.g., Jetty) has write permission to the db directory.</p>
		</blockquote>
		<h3 id="CustomSQLStatements">Custom SQL Statements</h3>
		<ol>
			<li>Copy the provided 
				<a href="storage/sql-statements.properties" class="file">$PLENS_INSTALL$/manual/storage/sql-statements.properties</a> to 
				<code>$IDP_HOME$/conf/uApprove.sql-statements.properties</code>.
			</li>
			<li>Adjust 
				<code>$IDP_HOME$/conf/uApprove.sql-statements.properties</code> according your needs.
			</li>
			<li>Enable your custom 
				<code>sql-statements.properties</code> in 
				<code>$IDP_HOME$/conf/uApprove.xml</code>:
			</li>
		</ol>
		<pre><pre>    &lt;bean id="uApprove.touModule" class="ch.SWITCH.aai.uApprove.tou.ToUModule" ...>
        &lt;!-- ... -->
        &lt;property name="storage">
            &lt;bean class="ch.SWITCH.aai.uApprove.tou.storage.JDBCStorage" ...
                p:sqlStatements="file:/$IDP_HOME$/conf/uApprove.sql-statements.properties" ... />
        &lt;/property>
    &lt;/bean>
    
    &lt;!-- ... -->
    
    &lt;bean id="uApprove.attributeReleaseModule" class="ch.SWITCH.aai.uApprove.ar.AttributeReleaseModule" ...>
        &lt;!-- ... -->
        &lt;property name="storage">
            &lt;bean class="ch.SWITCH.aai.uApprove.ar.storage.JDBCStorage" ...
               p:sqlStatements="file:/$IDP_HOME$/conf/uApprove.sql-statements.properties" ... />
        &lt;/property>
    &lt;/bean>
    
</pre></pre>
		<h2 id="GracefulJDBCConnectionHandling">Graceful JDBC Connection Handling</h2>
		<p>The JDBC storage can be configured to act graceful in case of a tempory database issue (e.g., communication link is not available). Instead throwing exceptions and display the error page, no persistent actions are applied.
			<br/>This implies that the users, idenpently of former ToU accetances and/or attribute release consents have to accept/consent again (if they already had) or have to do it during the next login (if it was the first time).
		</p>
		<p>N.B. It might make sense to set 
			<a href="http://www.mchange.com/projects/c3p0/#checkoutTimeout">checkoutTimeout</a> to an appropiate low value &#8211; so as the user has not bothersome latency.
		</p>
		<p>The settings are defined in 
			<code>$IDP_HOME$/conf/uApprove.xml</code>:
		</p>
		<pre><pre>    &lt;bean id="uApprove.touModule" class="ch.SWITCH.aai.uApprove.tou.ToUModule" ...>
        &lt;!-- ... -->
        &lt;property name="storage">
            &lt;bean class="ch.SWITCH.aai.uApprove.tou.storage.JDBCStorage" ...
                p:graceful="true" ... />
        &lt;/property>
    &lt;/bean>
    
    &lt;!-- ... -->
    
    &lt;bean id="uApprove.attributeReleaseModule" class="ch.SWITCH.aai.uApprove.ar.AttributeReleaseModule" ...>
        &lt;!-- ... -->
        &lt;property name="storage">
            &lt;bean class="ch.SWITCH.aai.uApprove.ar.storage.JDBCStorage" ...
               p:graceful="true" ... />
        &lt;/property>
    &lt;/bean>

</pre></pre>
		<h3 id="JDBCConnectionPoolTuning">JDBC Connection Pool Tuning</h3>
		<p>Cf. 
			<a href="http://www.mchange.com/projects/c3p0/#configuration">
				<code>c3p0</code> configuration
			</a> for further details on configuration options.
		</p>
		<p>The settings are defined in 
			<code>$IDP_HOME$/conf/uApprove.xml</code>:
		</p>
		<pre><pre>    &lt;bean id="uApprove.dataSource" class="com.mchange.v2.c3p0.ComboPooledDataSource" ...
        ...
        p:idleConnectionTestPeriod="300" ... />
</pre></pre>		        
		<p>N.B. You are free to use another JDBC connection pooling library (e.g., 
			<a href="http://jolbox.com/">BoneCP</a>). Just provide the right data source class name in the bean definition as well the required libraries in the classpath.
		</p>
		<h3 id="NOPStorage">NOP Storage</h3>
		<p>The 
			<acronym title="No Operation">NOP</acronym> storage basically retrieves users ToU acceptance and/or attribute release consent without requiring any JDBC storage.
			<br/>This implies 
			<em>alwaysRequireToUAcceptance</em> and/or 
			<em>alwaysRequireConsent</em>.
		</p>
		<p>You might enable 
			<acronym title="No Operation">NOP</acronym> storage for the ToU and/or attribute release module in 
			<code>$IDP_HOME$/conf/uApprove.xml</code>:
		</p>
		<pre><pre>    &lt;bean id="uApprove.touModule" ...
        ...
        &lt;property name="storage">
            &lt;bean class="ch.SWITCH.aai.uApprove.tou.storage.NOPStorage" />
        &lt;/property>
    &lt;/bean>
</pre></pre>
		<pre><pre>    &lt;bean id="uApprove.uApprove.attributeReleaseModule" ...
        ...
        &lt;property name="storage">
            &lt;bean class="ch.SWITCH.aai.uApprove.ar.storage.NOPStorage" />
        &lt;/property>
    &lt;/bean>
</pre></pre>
		<h3 id="OtherStorageImplementations">Other Storage Implementations</h3>
		<p>Custom storage implementations might be provided in future. Some ideas are:</p>
		<ul>
			<li>Cookie based Storage: This will remember users consent within a cookie. It could stored for just the session or some defined period (e.g., 10 days).</li>
		</ul>
		<h2 id="a4.3Templates">4.3 Templates</h2>
		<h3 id="CustomViewTemplates">Custom View Templates</h3>
		<p>Feel free to customize the 
			<acronym title="JavaServer Pages">JSP</acronym>, 
			<acronym title="Cascading Style Sheets">CSS</acronym> and image files located in 
			<code>$DP_INSTALL$/src/main/webapp/uApprove/</code>.
			<br/>For convienience the 
			<acronym title="JavaServer Pages Standard Tag Library">JSTL</acronym> is used, cf. 
			<a href="http://java.sun.com/products/jsp/jstl/reference/docs/index.html">JSTL reference</a>.
		</p>
		<h2 id="a4.4Localization">4.4 Localization</h2>
		<h3 id="CustomMessages">Custom Messages</h3>
		<p>You might adjust/extend the provided resource bundles in 
			<a href="examples/messages" class="file">$PLENS_INSTALL$/manual/examples/messages</a> and copy them into the IdPs classpath (e.g., 
			<code>$IDP_INSTALL$/src/main/webapp/WEB-INF/classes/uApprove/messages</code>).
			<br/>Specify your bundles base in 
			<code>$IDP_HOME$/conf/uApprove.xml</code>:
		</p>
		<pre><pre>    &lt;bean id="uApprove.viewHelper" class="ch.SWITCH.aai.uApprove.ViewHelper" ...
        p:messagesBase="uApprove.messages" />
</pre></pre>
		<h3 id="AttributeNamesandDescriptions">Attribute Names and Descriptions</h3>
		<p>See 
			<a href="examples/attribute-descriptions.xml" class="file">$PLENS_INSTALL$/manual/examples/attribute-descriptions.xml</a> for an example how to configure the localized attribute names and descriptions.
		</p>
		<h3 id="RelyingPartyNamesandDescriptions">Relying Party Names and Descriptions</h3>
		<p>Currently only the attribute consuming service descriptors in metadata are supported, to retrieve localized relying party names and descriptions.
			<br/>For providing such names and descriptions extend the metadata for the SP like:
		</p>
		<pre><pre>&lt;EntityDescriptor entityID="https://sp.example.org/shibboleth">
    &lt;!-- ... -->
    &lt;SPSSODescriptor>
        &lt;!-- ... -->
        &lt;AttributeConsumingService index="1">
            &lt;ServiceName xml:lang="en">Example SP&lt;/ServiceName>
            &lt;!-- Service names in other languages -->
            &lt;ServiceDescription xml:lang="en">Some description of Example SP&lt;/ServiceDescription>
            &lt;!-- Service descriptions in other languages -->
        &lt;/AttributeConsumingService>
    &lt;/SPSSODescriptor>
&lt;/EntityDescriptor>
</pre></pre>
		<p>Note:</p>
		<ul>
			<li>The metadata of the SWITCHaai federation contain these information.</li>
		</ul>
		<h2 id="a4.5StrictComparison">4.5 Strict Comparison</h2>
		<h3 id="TermsOfUseContentComparison">Terms Of Use Content Comparison</h3>
		<p>In the default configuration, only the ToU version is compared to evaluate if a user accepted the ToU. You might enable that the ToU content is compared too in 
			<code>$IDP_HOME$/conf/uApprove.xml</code>: 
		</p>
		<pre><pre>&lt;bean id="uApprove.touModule" ... p:compareContent="true" ...
</pre></pre>
		<h3 id="AttributeValuesComparison">Attribute Value(s) Comparison</h3>
		<p>In the default configuration, only the attribute ID is compared to evaluate if a user consented attibute release. You might enable that attribute value(s) are compared too in 
			<code>$IDP_HOME$/conf/uApprove.xml</code>: 
		</p>
		<pre><pre>&lt;bean id="uApprove.attributeReleaseModule" ... p:compareAttributeValues="true" ...
</pre></pre>
		<h2 id="a4.6AuditLogging">4.6 Audit Logging</h2>
		<p>uApprove allows (faciliating the IDP&#8217;s audit log) to enable audit logging to 
			<code>$IDP_HOME$/logs/idp-audit.log</code>.
		</p>
		<h3 id="EnableTermsOfUseAuditLog">Enable Terms Of Use Audit Log</h3>
		<p>You might enable ToU audit log in in 
			<code>$IDP_HOME$/conf/uApprove.xml</code>: 
		</p>
		<pre><pre>&lt;bean id="uApprove.touModule" ... p:auditLogEnabled="true" ...
</pre></pre>
		<p>Example:</p>
		<pre><pre>20120101T010000Z|ch.SWITCH.aai.uApprove|||tou.acceptance|null|null|null|student1||1.0,5b2ee897c08c79a09cd57e8602d605bf8c52db17de9793677c36b5c78644b2b3,|
</pre></pre>
		<h3 id="EnableAttributeReleaseAuditLog">Enable Attribute Release Audit Log</h3>
		<p>You might enable attribute release audit log in in 
			<code>$IDP_HOME$/conf/uApprove.xml</code>:
		</p>
		<pre><pre>&lt;bean id="uApprove.attributeReleaseModule" ... p:auditLogEnabled="true" ...
</pre></pre>
		<p>Examples:</p>
		<pre><pre>20120101T010000Z|ch.SWITCH.aai.uApprove||https://sp.example.org/shibboleth|ar.consent|null|null|null|student1||uid,surname,givenName,|
20120101T010000Z|ch.SWITCH.aai.uApprove||https://sp.example.org/shibboleth|ar.clearConsent|null|null|null|student1|||
20120101T010000Z|ch.SWITCH.aai.uApprove|||ar.generalConsent|null|null|null|student1|||
</pre></pre>
		<h2 id="a4.7AttributeInAttributeRequestersMetadataPlugin">4.7 Attribute In Attribute Requester&#8217;s Metadata Plugin</h2>
		<h3 id="Installation">Installation</h3>
		<p>The plugin is installed by default with uApprove (
			<code>uApprove-#version#.jar</code>). 
		</p>
		<h3 id="ConfigurationAttributeInRequestersMetadataMatchingRule">Configuration Attribute In Requester&#8217;s Metadata Matching Rule</h3>
		<p>This rule allows the release of an attribute if, via its metadata, the SP indicates a need/desire for the attribute. The attributes are indicated by means of 
			<code>&lt;AttributeConsumingService></code> elements within the 
			<code>&lt;SPSSODescriptor></code> element. See SAML metadata for more information.
		</p>
		<p>While this rule does have some minor support for dealing with attribute values within the metadata it is limited and should be considered experimental.
			<br/><blockquote class="note">
			<br/>Please be aware of the following:
		</p>
		<ul>
			<li>This filter requires the attribute requester&#8217;s metadata be loaded and available.</li>
			<li>The requester&#8217;s metadata must have an 
				<code>&lt;SPSSODescriptor</code> role since that is the role that contains the listed attributes.
			</li>
			<li>This matching function only operates as a value rule and only really makes sense as a permit value rule.</li>
		</ul>
		<p></blockquote></p>
		<h4 id="DefinetheNamespace">Define the Namespace</h4>
		<p>In your attribute filter policy file you&#8217;ll need to add the namespace declaration for this plugin. To do this:</p>
		<ul>
			<li>Add the attribute 
				<code>xmlns:ua="http://www.switch.ch/aai/idp/uApprove/mf"</code> before the 
				<code>xmlns:xsi</code> attribute on the root 
				<code>&lt;AttributeFilterPolicyGroup></code> element.
			</li>
			<li>Add the following at the end of the whitespace delimited list of values for the 
				<code>xsi:schemaLocation</code> attribute: 
				<code>http://www.switch.ch/aai/idp/uApprove/mf classpath:/schema/uApprove-mf.xsd</code>.
			</li>
		</ul>
		<h4 id="DefinetheRule">Define the Rule</h4>
		<p>This rule is defined by the element 
			<code>&lt;PermitValueRule xsi:type="ua:AttributeInMetadata"></code> with the following optional attribute: 
		</p>
		<p>[onlyIfRequired] Boolean flag indicated that only those attributes which are marked as required should be released, those marked as optional will not be. Default value: 
			<code>true</code>.
		</p>
		<p>Example Permit Value Rule using the AttributeInMetadata Match Function: </p>
		<pre><pre>&lt;PermitValueRule xsi:type="ua:AttributeInMetadata" onlyIfRequired="false">
</pre></pre>
		<h2 id="a4.8Other">4.8 Other</h2>
		<p>Other topics will be added upon request. Some candidates are:</p>
		<ul>
			<li>Black/Whitelisting
				<ul>
					<li>Different Lists for Terms Of Use and Attribute Release Module</li>
					<li>Specific authContextClassRef required</li>
				</ul>
			</li>
		</ul>
		<h1 id="a5Troubleshooting">5 Troubleshooting</h1>
		<ul>
			<li>Check 
				<code>$IDP_HOME$/logs/idp-process.log</code> for 
				<code>ERROR</code> or 
				<code>WARN</code> messages.
			</li>
			<li>Check container standard error/out (e.g., Jetty&#8217;s 
				<code>$JETTY_HOME$/logs/`date +%Y_%m_%d`.stderrout.log</code>) for error messages.
			</li>
		</ul>
		<h2 id="Debugging">Debugging</h2>
		<p>Enabling 
			<code>DEBUG</code> or 
			<code>TRACE</code> log level for uApprove in 
			<code>$IDP_HOME$/conf/logging.xml</code>:
		</p>
		<pre><pre>&lt;logger name="ch.SWITCH.aai.uApprove" level="DEBUG"/>
</pre></pre>
		<h1 id="a6Feedback">6 Feedback</h1>
		<p>Send general questions and comments to 
			<a href="mailto:privacylens@ece.cmu.edu">privacylens@ece.cmu.edu</a>. For bug reports, please use our 
			<a href="https://github.com/cmu-cylab-privacylens/PrivacyLens/issues">issue tracking</a>.
		</p>
		<p id="___fn1" class="footnote">
			<sup>1</sup> Clear means to delete general consent if it was given as well delete as all attribute release consents for the accessed relying party.
		</p>
	</body>
</html>