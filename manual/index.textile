
This document contains the uApprove deployment guide.

h1. 1 Installation

h2. 1.1 Prerequisites

* Shibboleth Identity Provider 2.3 or greater.
* Database which supports JDBC.

h2. 1.2 Assumptions

* The Shibboleth Identity Provider is unpacked at @$IDP_INSTALL$@ (e.g., @/opt/shibboleth-identity-provider-#version#@).
* The Shibboleth Identity Provider is installed at @$IDP_HOME$@ (e.g., @/opt/shibboleth-idp@).
* "uApprove":http://www.switch.ch/aai/uApprove is downloaded and unpacked at @$UAPPROVE_INSTALL$@ (e.g., @/tmp/uApprove-#version#@).

h2. 1.3 Library Installation

Copying the libraries to the IdPs library directory:

* @cp $UAPPROVE_INSTALL$/lib/*.jar $IDP_INSTALL$/lib@
* @cp $UAPPROVE_INSTALL$/lib/jdbc/*.jar $IDP_INSTALL$/lib@
* Provide the JDBC connector for your database to the classpath of the IdP. You might use one of the provided MySQL or HSQL JDBC connector: <br /> @cp $UAPPROVE_INSTALL$/lib/jdbc/optional/#jdbc-connector#.jar $IDP_INSTALL$/lib@

bq(note). Assure that only one version of each library is present in @$IDP_INSTALL$/lib@.

h2. 1.4 Configuration Template

Copying the configuration template to the IdPs configuration directory:

* @cp@ "(file)$UAPPROVE_INSTALL$/manual/configuration/uApprove.properties":configuration/uApprove.properties @$IDP_HOME$/conf@
* @cp@ "(file)$UAPPROVE_INSTALL$/manual/configuration/uApprove.xml":configuration/uApprove.xml @$IDP_HOME$/conf@

h2. 1.5 Webapp files

Copying of the web application files like the JSP(Java Server Pages)s, CSS(Cascading Style Sheet) files and images to the IdPs webapp directory:

* @mkdir $IDP_INSTALL$/src/main/webapp/uApprove@
* @cp $UAPPROVE_INSTALL$/webapp/* $IDP_INSTALL$/src/main/webapp/uApprove@

h2. 1.6 Database Preparation

bq(note). The following database parameters are examples.

* Create a database with the name "uApprove".
* Create a database user with the username "uApprove" and password "uApprove".
* Grant @INSERT, SELECT, UPDATE, DELETE@ rights for the user.
* Create the initial table structures using the schemas:
** "(file)$UAPPROVE_INSTALL$/manual/storage/terms-of-use-schema.sql":storage/terms-of-use-schema.sql.
** "(file)$UAPPROVE_INSTALL$/manual/storage/attribute-release-schema.sql":storage/attribute-release-schema.sql.

h1. 2 Basic Deployment

h2. 2.1 Web Application Deployment Descriptor

Extend the IdP web application deployment descriptor (@$IDP_INSTALL$/src/main/webapp/WEB-INF/web.xml@):

bc.. 

<web-app ...>

    <context-param>
        <param-name>contextConfigLocation</param-name>
        <param-value>$IDP_HOME$$/conf/internal.xml; $IDP_HOME$/conf/service.xml; $IDP_HOME$/conf/uApprove.xml</param-value>
    </context-param>

    <!-- IdP Listeners, Filters and Servlets -->
    <!-- ...                                 -->
    
    
    <!-- uApprove Filter and Servlets -->
    
    <filter>
        <filter-name>uApprove</filter-name>
        <filter-class>ch.SWITCH.aai.uApprove.Intercepter</filter-class>
    </filter>

    <filter-mapping>
        <filter-name>uApprove</filter-name>
        <url-pattern>/profile/*</url-pattern>
        <url-pattern>/Authn/UserPassword</url-pattern>
    </filter-mapping>

    <servlet>
        <servlet-name>uApprove - Terms Of Use</servlet-name>
        <servlet-class>ch.SWITCH.aai.uApprove.tou.ToUServlet</servlet-class>
    </servlet>

    <servlet-mapping>
        <servlet-name>uApprove - Terms Of Use</servlet-name>
        <url-pattern>/uApprove/TermsOfUse</url-pattern>
    </servlet-mapping>

    <servlet>
        <servlet-name>uApprove - Attribute Release</servlet-name>
        <servlet-class>ch.SWITCH.aai.uApprove.ar.AttributeReleaseServlet</servlet-class>
    </servlet>

    <servlet-mapping>
        <servlet-name>uApprove - Attribute Release</servlet-name>
        <url-pattern>/uApprove/AttributeRelease</url-pattern>
    </servlet-mapping>

</web-app>
h2. 2.2 Custom Configuration

In @$IDP_HOME$/conf/uApprove.xml@ change:

bc. 
<context:property-placeholder location="classpath:/configuration/uApprove.properties" />

to:

bc. 
<context:property-placeholder location="file:$IDP_HOME$/conf/uApprove.properties" />

Customize @$IDP_HOME$/conf/uApprove.properties@ according your database environment and required features. See "inline documentation":configuration/uApprove.properties for configuration options.


h2. 2.3 Deployment

To activate uApprove the IdP must be re-deployed:

bc. $IDP_INSTALL$/install.sh


h1. 3 Upgrade 

bq(warn). If your upgrading from uApprove < 2.3 please read the according "upgrade information":#a3.1UpgradefromuApprove2.3 and
follow the "installation instructions":#a1Installation.

* @rm $IDP_INSTALL$/lib/uApprove-#old-version#.jar@
* @cp $UAPPROVE_INSTALL$/lib/uApprove-#new-version#.jar $IDP_INSTALL$/lib@

Optionally update the JDBC dependencies:

* @cp $UAPPROVE_INSTALL$/lib/jdbc/*.jar $IDP_INSTALL$/lib@

Optionally update the JDBC connector for your database. You might use one of the provided MySQL or HSQL JDBC connector:

* @cp $UAPPROVE_INSTALL$/lib/jdbc/optional/#jdbc-connector#.jar $IDP_INSTALL$/lib@


bq(warn). Verify that only one version of each library is present in @$IDP_INSTALL$/lib@.


bq(note). Optionally update the web application and configuration files if you do not have any customizations.
It is recommended to backup the old files first.

To finish the upgrade of uApprove the IdP must be re-deployed:

bc. $IDP_INSTALL$/install.sh

h2. 3.1 Upgrade from uApprove < 2.3

* Legacy uApprove (< 2.3) deployment: Please remove it.
* Configuration files: Please use the new configuration file and tailor them to your needs. Note: The new ToU is an HTML file, which you can customize, just copy the content from your lecacy ToU XML to a plain HTML file.
* Database Migration: It is possible to migrate ToU acceptance and attribute release consent data using the "provided data migration script":#DatabaseMigration.

bq(note). If _Terms Of Use Content Comparison_ and/or _Attribute Value Comparison_ feature will be used,
the lecacy database entries can not be used and must not be migrated.

h3. Database Migration

Migrate lecacy database to the new database:

bc. 
java -cp "$UAPPROVE_INSTALL$/scripts/lib/*.jar:$UAPPROVE_INSTALL$/lib/jdbc/optional/*.jar" groovy.ui.GroovyMain \
  $UAPPROVE_INSTALL$/scripts/StorageMigration.groovy /opt/uApprove/conf/database.properties $IDP_HOME$/conf/uApprove.properties


h1. 4 Advanced Deployment

This sections contains advanced configuration topics.

h2. 4.1 Reset Attribute Release Consent

For providing the feature that a user is able to clear[1] her attribute release consent during the login flow, 
add a checkbox to @$IDP_INSTALL$/src/main/webapp/login.jsp@:

bc. 
<form action="<%=request.getAttribute("actionUrl")%>" method="post">
  ...
  <input id="uApprove.consent-revocation" type="checkbox" name="uApprove.consent-revocation" value="true"/>
  <label for="uApprove.consent-revocation">Clear my attribute release consent</label>
  ...
</form>

h2. 4.2 Storage

h3. File-only

For a simple deployment a file only database can be used. HSQL provides such an option.
Define the according database properties in @uApprove.properties@:

bc. 
database.driver             = org.hsqldb.jdbcDriver
database.url                = jdbc:hsqldb:file:/var/opt/uApprove/hsql.db
database.username           = SA
database.password           = 
 
Initializing the database with the provided schemas:

bc. 
echo "SHUTDOWN;" > /tmp/shutdown
java -jar $HSQLDB_HOME$/lib/sqltool.jar \
  --inlineRC=url=jdbc:hsqldb:file:/var/opt/uApprove/hsql.db,user=SA,password= \
  $UAPPROVE_INSTALL$/manual/storage/terms-of-use-schema.sql /tmp/shutdown
java -jar $HSQLDB_HOME$/lib/sqltool.jar \
  --inlineRC=url=jdbc:hsqldb:file:/var/opt/uApprove/hsql.db,user=SA,password= \
  $UAPPROVE_INSTALL$/manual/storage/attribute-relase-schema.sql /tmp/shutdown
  
  
bq(note). @$HSQLDB_HOME$@ defines the location where the downloaded "HSQL distribution":http://hsqldb.org/ is extracted.

bq(note). Assure that the user running the container (e.g., Jetty) has write permission to the db directory.

h3. Custom SQL Statements

# Copy the provided "(file)$UAPPROVE_INSTALL$/manual/storage/sql-statements.properties":storage/sql-statements.properties to @$IDP_HOME$/conf/uApprove.sql-statements.properties@.
# Adjust @$IDP_HOME$/conf/uApprove.sql-statements.properties@ according your needs.
# Enable your custom @sql-statements.properties@ in @$IDP_HOME$/conf/uApprove.xml@:

bc.. 
    <bean id="uApprove.touModule" class="ch.SWITCH.aai.uApprove.tou.ToUModule" ...>
        <!-- ... -->
        <property name="storage">
            <bean class="ch.SWITCH.aai.uApprove.tou.storage.JDBCStorage" init-method="initialize"
                p:dataSource-ref="uApprove.dataSource" p:sqlStatements="file:/$IDP_HOME$/conf/uApprove.sql-statements.properties" />
        </property>
    </bean>
    
    <!-- ... -->
    
    <bean id="uApprove.attributeReleaseModule" class="ch.SWITCH.aai.uApprove.ar.AttributeReleaseModule" ...>
        <!-- ... -->
        <property name="storage">
            <bean class="ch.SWITCH.aai.uApprove.ar.storage.JDBCStorage" init-method="initialize"
                p:dataSource-ref="uApprove.dataSource" p:sqlStatements="file:/$IDP_HOME$/conf/uApprove.sql-statements.properties" />
        </property>
    </bean>

h3. JDBC Connection Pool Tuning

Cf. "BoneCP config API":http://jolbox.com/bonecp/downloads/site/apidocs/com/jolbox/bonecp/BoneCPConfig.html for a list of all the available configuration settings.

The settings are defined in @$IDP_HOME$/conf/uApprove.xml@:

bc. 
    <bean id="uApprove.dataSource" class="com.jolbox.bonecp.BoneCPDataSource" ...
        p:minConnectionsPerPartition="1" p:maxConnectionsPerPartition="20" ... />

h3. Custom Storage

Custom storage implementations might be provided in future. Some ideas are:

* NOP(No Operation) Storage: This basically will retrieve users ToU acceptance and/or attribute release consent without remembering. This implies _alwaysRequireToUAcceptance_ and/or _alwaysRequireConsent_.
* Cookie based Storage: This will remember users consent within a cookie. It could stored for just the session or some defined period (e.g., 10 days).
* In Memory Storage: Already possible with @mem@ HSQLDB. Will store consent as long as the IdP process is alive. Needs DB shema initialization.

h2. 4.3 Templates

h3. Custom View Templates

Feel free to customize the JSP(JavaServer Pages), CSS(Cascading Style Sheets) and image files located in @$UAPPROVE_INSTALL$/webapp/@.
For convienience the JSTL(JavaServer Pages Standard Tag Library) is used, cf. "JSTL reference":http://java.sun.com/products/jsp/jstl/reference/docs/index.html.

h2. 4.4 Localization

h3. Custom Messages

You might adjust/extend the "contained":https://subversion.switch.ch/svn/general/aai/uApprove/trunk/src/main/resources/messages/ resource bundles and place them in the IdPs classpath (e.g., @$IDP_INSTALL$/src/main/webapp/WEB-INF/classes/uApproveMessages@).
Specify your bundles base in @$IDP_HOME$/conf/uApprove.xml@:

bc. 
    <bean id="uApprove.viewHelper" class="ch.SWITCH.aai.uApprove.ViewHelper" ...
        p:messagesBase="uApproveMessages" />

h3. Attribute Names and Descriptions

See "(file)attribute-descriptions.xml":examples/attribute-descriptions.xml for an example how to configure the localized attribute names and descriptions.

h3. Relying Party Names and Descriptions

Currently only the attribute consumin service descriptors in metadata are supported, toe retrieve localized relying arty names and descriptions.
For providing such names and descriptions extend the metadata for the SP like:

bc. 
<EntityDescriptor entityID="https://sp.example.org/shibboleth">
    <!-- ... -->
    <SPSSODescriptor>
        <!-- ... -->
        <AttributeConsumingService index="1">
            <ServiceName xml:lang="en">Example SP</ServiceName>
            <!-- Service names in other languages -->
            <ServiceDescription xml:lang="en">Some description of Example SP</ServiceDescription>
            <!-- Service descriptions in other languages -->
        </AttributeConsumingService>
    </SPSSODescriptor>
</EntityDescriptor>

h2. 4.5 Attribute In Attribute Requester's Metadata Plugin

h3. Installation

The plugin is installed by default with uApprove (@uApprove-#version#.jar@). 

h3. Configuration Attribute In Requester's Metadata Matching Rule

This rule allows the release of an attribute if, via its metadata, the SP indicates a need/desire for the attribute. The attributes are indicated by means of @<AttributeConsumingService>@ elements within the @<SPSSODescriptor>@ element. See SAML metadata for more information.

While this rule does have some minor support for dealing with attribute values within the metadata it is limited and should be considered experimental.
<blockquote class="note">
Please be aware of the following:
* This filter requires the attribute requester's metadata be loaded and available.
* The requester's metadata must have an @<SPSSODescriptor@ role since that is the role that contains the listed attributes.
* This matching function only operates as a value rule and only really makes sense as a permit value rule.
</blockquote>

h4. Define the Namespace

In you attribute filter policy file you'll need to add the namespace declaration for this plugin. To do this:

* Add the attribute @xmlns:ua="http://www.switch.ch/aai/idp/uApprove/mf"@ before the @xmlns:xsi@ attribute on the root @<AttributeFilterPolicyGroup>@ element.
* Add the following at the end of the whitespace delimited list of values for the @xsi:schemaLocation@ attribute: @http://www.switch.ch/aai/idp/uApprove/mf classpath:/schema/uApprove-mf.xsd@.

h4. Define the Rule

This rule is defined by the element @<PermitValueRule xsi:type="ua:AttributeInMetadata">@ with the following optional attribute: 

[onlyIfRequired] Boolean flag indicated that only those attributes which are marked as required should be released, those marked as optional will not be. Default value: @true@.

Example Permit Value Rule using the AttributeInMetadata Match Function: 

bc. <PermitValueRule xsi:type="ua:AttributeInMetadata" onlyIfRequired="false">

h2. 4.6 Other

Other topics will be added upon request. Some candidates are:

* Strict Comparison
** Terms Of Use Content Comparison
** Attribute Value Comparison
* Black/Whitelisting
** Different Lists for Terms Of Use and Attribute Release Module
** Specific authContextClassRef required

h1. 5 Troubleshooting

h2. Logging

Fatal errors may found in the containter standard error/out (e.g., Jetty's @$JETTY_HOME$/logs/`date +%Y_%m_%d`.stderrout.log@).

uApprove logs to @$IDP_HOME$/logs/idp-process.log@. For enabling @DEBUG@ log level, define a corresponding logger in @$IDP_HOME$/conf/logging.xml@:

bc. <logger name="ch.SWITCH.aai.uApprove" level="DEBUG"/>

h1. 6 Feedback

Send general questions and comments to "aai@switch.ch":mailto:aai@switch.ch. For bug reports, please use our "issue tracking":http://forge.switch.ch/redmine/projects/uapprove.


fn1. Clear means to delete general consent if it was given as well delete as all attribute release consents for the accessed relying party.


